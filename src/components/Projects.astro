---
import Card from '@components/ui/Card.astro';
import { getCollection } from 'astro:content';
import type { ImageMetadata } from 'astro';
import imagetrain from '@assets/images/train_gui.png';
import imageSAE from '@assets/images/SAE3A.png';
import imageNDI from '@assets/images/NDI.png';
import imageStage from '@assets/images/stage.png';
import imageAlternance from '@assets/images/project.png';

const projects = await getCollection('projects');

// Filtrer les projets désactivés
const activeProjects = projects.filter(project => !project.data.disabled);

// Mapper les images par slug pour correspondance exacte
const imageMap: { [key: string]: ImageMetadata } = {
	'train': imagetrain,
	'sae3a': imageSAE,
	'ndi': imageNDI,
	'stage': imageStage,
	'alternance': imageAlternance,
};
---

<section
	data-testid="projects"
	id="projects"
	class="py-16 px-4 text-gray-900 dark:text-gray-100"
>
	<div class="text-center mb-12">
		<h2 class="font-monospace text-2xl text-orange lg:text-4xl mb-4">Projets</h2>
		<hr class="w-1/2 border-orange-500 mx-auto" />
	</div>

	<!-- Carrousel Container -->
	<div class="relative max-w-7xl mx-auto">
		<!-- Bouton Précédent -->
		<button
			id="prevBtn"
			class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-orange-500 hover:bg-orange-600 text-white rounded-full p-3 shadow-lg transition-all duration-300 hover:scale-110"
			aria-label="Projet précédent"
		>
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
			</svg>
		</button>

		<!-- Carrousel -->
		<div id="carouselContainer" class="overflow-x-auto overflow-y-hidden px-12 scrollbar-hide" style="scroll-behavior: smooth;">
			<div
				id="carousel"
				class="flex gap-6"
			>
				{activeProjects.map((project) => {
					// Utiliser le slug personnalisé si disponible, sinon utiliser le slug du fichier
					const projectSlug = project.data.slug || project.slug;
					return (
						<div class="flex-shrink-0 w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)]">
							<Card
								title={project.data.title}
								description={project.data.description}
								tags={project.data.tags}
								url={project.data.url}
								imageUrl={imageMap[projectSlug]}
							/>
						</div>
					);
				})}
			</div>
		</div>

		<!-- Bouton Suivant -->
		<button
			id="nextBtn"
			class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-orange-500 hover:bg-orange-600 text-white rounded-full p-3 shadow-lg transition-all duration-300 hover:scale-110"
			aria-label="Projet suivant"
		>
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
			</svg>
		</button>
	</div>

	<!-- Indicateurs de pagination -->
	<div id="dotsContainer" class="flex justify-center gap-2 mt-8">
		{activeProjects.map((_, index) => (
			<button
				class={`carousel-dot w-3 h-3 rounded-full transition-all duration-300 ${index === 0 ? 'bg-orange-500 scale-125' : 'bg-gray-300 dark:bg-gray-600'}`}
				data-index={index}
				aria-label={`Aller au projet ${index + 1}`}
			></button>
		))}
	</div>
</section>

<script>
	const carouselContainer = document.getElementById('carouselContainer');
	const carousel = document.getElementById('carousel');
	const prevBtn = document.getElementById('prevBtn');
	const nextBtn = document.getElementById('nextBtn');
	const dots = document.querySelectorAll('.carousel-dot');

	// Vérifier que tous les éléments existent
	if (!carouselContainer || !carousel || !prevBtn || !nextBtn) {
		console.error('Carousel elements not found');
	} else {
		// Calculer dynamiquement le nombre de cartes
		const totalCards = carousel.children.length;

		function getCardsPerView() {
			if (window.innerWidth >= 1024) return 3; // lg
			if (window.innerWidth >= 768) return 2; // md
			return 1; // mobile
		}

		function getCurrentIndex() {
			if (!carouselContainer || !carousel) return 0;

			const firstChild = carousel.children[0] as HTMLElement;
			if (!firstChild) return 0;

			const cardWidth = firstChild.offsetWidth;
			const gap = 24;
			const scrollLeft = carouselContainer.scrollLeft;
			const index = Math.round(scrollLeft / (cardWidth + gap));

			return Math.max(0, Math.min(index, totalCards - 1));
		}

		function updateIndicators() {
			if (!carouselContainer || !prevBtn || !nextBtn) return;

			const currentIndex = getCurrentIndex();

			dots.forEach((dot, index) => {
				if (index === currentIndex) {
					dot.classList.remove('bg-gray-300', 'dark:bg-gray-600');
					dot.classList.add('bg-orange-500', 'scale-125');
				} else {
					dot.classList.remove('bg-orange-500', 'scale-125');
					dot.classList.add('bg-gray-300', 'dark:bg-gray-600');
				}
			});

			// Gérer la visibilité des boutons
			const maxScroll = carouselContainer.scrollWidth - carouselContainer.clientWidth;
			const isAtStart = carouselContainer.scrollLeft <= 10;
			const isAtEnd = carouselContainer.scrollLeft >= maxScroll - 10;

			prevBtn.style.opacity = isAtStart ? '0.5' : '1';
			prevBtn.style.pointerEvents = isAtStart ? 'none' : 'auto';
			nextBtn.style.opacity = isAtEnd ? '0.5' : '1';
			nextBtn.style.pointerEvents = isAtEnd ? 'none' : 'auto';
		}

		function scrollToCard(index: number) {
			if (!carouselContainer || !carousel) return;

			const firstChild = carousel.children[0] as HTMLElement;
			if (!firstChild) return;

			const cardWidth = firstChild.offsetWidth;
			const gap = 24;
			const scrollPosition = index * (cardWidth + gap);

			carouselContainer.scrollTo({
				left: scrollPosition,
				behavior: 'smooth'
			});
		}

		prevBtn.addEventListener('click', () => {
			const currentIndex = getCurrentIndex();
			scrollToCard(Math.max(0, currentIndex - 1));
		});

		nextBtn.addEventListener('click', () => {
			const currentIndex = getCurrentIndex();
			const cardsPerView = getCardsPerView();
			const maxIndex = Math.max(0, totalCards - cardsPerView);
			scrollToCard(Math.min(maxIndex, currentIndex + 1));
		});

		dots.forEach((dot, index) => {
			dot.addEventListener('click', () => {
				scrollToCard(index);
			});
		});

		// Écouter le scroll pour mettre à jour les indicateurs
		carouselContainer.addEventListener('scroll', () => {
			updateIndicators();
		});

		// Responsive
		window.addEventListener('resize', () => {
			updateIndicators();
		});

		// Support du swipe sur mobile (déjà géré par le scroll natif, mais on peut améliorer)
		let touchStartX = 0;
		let scrollStartX = 0;

		carouselContainer.addEventListener('touchstart', (e) => {
			if (!carouselContainer) return;
			touchStartX = e.touches[0].clientX;
			scrollStartX = carouselContainer.scrollLeft;
		});

		carouselContainer.addEventListener('touchmove', (e) => {
			if (!carouselContainer || !touchStartX) return;
			const touchX = e.touches[0].clientX;
			const diff = touchStartX - touchX;
			carouselContainer.scrollLeft = scrollStartX + diff;
		});

		carouselContainer.addEventListener('touchend', () => {
			touchStartX = 0;
			scrollStartX = 0;
		});

		// Initialiser
		updateIndicators();
	}
</script>

<style>
	/* Cacher la scrollbar sur tous les navigateurs */
	.scrollbar-hide {
		-ms-overflow-style: none;  /* IE and Edge */
		scrollbar-width: none;  /* Firefox */
	}

	.scrollbar-hide::-webkit-scrollbar {
		display: none;  /* Chrome, Safari and Opera */
	}
</style>

